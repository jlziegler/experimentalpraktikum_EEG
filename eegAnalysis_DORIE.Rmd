---
title: "EEG Analysis Dorie (iMMN)"
author: "Joshua Ziegler"
date: "12.01.2021"
output: html_document
---

Vor der Analyse in R:    

- Einladen der Daten in EEGLab    
- Exportieren als .set -> wird hierfür MNE benötigt?    
- oder exportieren als EDF? -> benötigt biosig

```{r setup, include=FALSE}
# packages
library(eegUtils) # angefangen mit Version 0.5.0
library(tidyverse)
```

1. Schritt:     
Laden der Daten in EEGLAB -> exportieren als .set -> laden des Datensets in R (.set & .fdt benötigt):   
```{r load data, echo=T}
# test <- import_set("./raw/DOR_02.set")
```

Fehlermeldung:

> Fehler: Can't subset columns that don't exist.  
> x Column `epoch` doesn't exist.

-> Muss wirklich schon die Epochierung gemacht sein? Wozu gibt es dann die Funktion ```epoch_data()```? -> Erstmal versuchen, die Channel-Locations zu definieren   

Versuch 2 (Channel Locations in EEGLAB definiert):

-> gleiche Fehlermeldung -> nächster Schritt: Develop Branch von GitHub geladen:   
```remotes::install_github("craddm/eegUtils@develop")```    

Versuch 3: versuchen die .vhdr-Datei mit der Funktion ```import_raw()``` zu laden:

# Daten importieren
```{r import raw, echo=T}
dor02_raw <- import_raw("./raw/DOR02.vhdr", participant_id = "DOR02")
```

-> klappt! Einzige Sorge: **"No channel locations found"** -> nur für Topo relevant
-> Lösung: ```electrode_locations()```

# Channel-Locations zuweisen
```{r channel locations, echo=T}
dor02_chl <- electrode_locations(dor02_raw, 
                                 overwrite = T,
                                 method = "biosemi64"
                                 )
```
Erkennt Augenelektroden und alle mit "z" nicht...
Manuell hinzufügen?

# Vorverarbeitung   

## Daten filtern
```{r bandpass, echo=T}
dor02_flt <- eeg_filter(dor02_chl,
                        low_freq = 0.1,
                        high_freq = 30,
                        method = "fir"
                        )
```

## Re-Referenzierung
```{r re-ref, echo=T}
dor02_ref <- eeg_reference(dor02_flt, 
                           ref_chans = c("A1", "A2")
                           )
```

## Epochierung
```{r epoch, echo=T}
dor02_epo <- epoch_data(dor02_ref,
                        events = c("S111",
                                   "S112",
                                   "S212",
                                   "S211",
                                   "S121",
                                   "S123",
                                   "S223",
                                   "S221"),
                        epoch_labels = c("oeStan",    # o-e (o-Standard)
                                         "eoStan",    
                                         "oeDev",
                                         "eoDev",     # e-o (o-Deviant)
                                         "ouStan",
                                         "uoStan",
                                         "ouDev",
                                         "uoDev"),
                        time_lim = c(-.2, .8),
                        baseline = c(-.2, 0))
```

# ICA

## Run ICA
SOBI

```{r ICA, echo=T}
dor02_ICA <- run_ICA(dor02_epo)
```

## Plot ICA

```{r plot ICA, echo=T}
# interactive:
# view_ica(dor02_ICA)
# individual components:
# topoplot(dor02_ICA, component = 2)
# plot_timecourse(dor02_ICA, component = 2)
```

## Augenbewegungen
```{r ICA augen, echo=T}
dor02_eogICA <- ar_eogcor(decomp = dor02_ICA, 
                          data = dor02_epo, 
                          HEOG = c("HEOGli", "HEOGre"), 
                          VEOG = c("VEOGo", "VEOGu")
                          )
```


## Muskelartefakte
```{r}

```

## Channel ICA
```{r}

```

## Trial ICA
```{r}

```

## remove components
```{r}
dor02_cln <- apply_ica(data = dor02_epo, decomp = dor02_ICA, comps = dor02_eogICA)
```

Funktionensammlung:   

- Browse Data: ```browse_data(data)```    
- ICA Viewer: ```view_ica(dor02_ICA)```
- Plot Power Spectral Density: ```plot_psd()```
- Eventliste: ```list_events()```
- ERP-Plot Example: ```plot_timecourse(dor02_epo, "FCz", colour = "event_type")``` -> plot Funktionen sind ggplot objekte! 
```{r}
# grober example plot
dor02_epo %>%
    filter(epoch_labels %in% c("uoDev", "ouStan")) %>%  # erst filtern nach Epoche
    as.data.frame(long = TRUE) %>%   # dann als dataframe
    filter(electrode == "FCz") %>%   # dann nach elektrode filtern
    ggplot(aes(x = time, y = amplitude)) +
      stat_summary(fun = mean, 
                 geom = "line", 
                aes(colour = epoch_labels)) + 
      facet_wrap(~electrode) + # wenn mehrere elektroden
      scale_y_reverse()
```
- Plot mit eegUtils Funktion:
```{r}
dor02_cln %>% 
  select_epochs(epoch_no = dor02_cln$epochs$epoch[dor02_cln$epochs$epoch_labels=="ouStan"]) %>% # wie mehrere Epochen????
  plot_timecourse("FCz", colour = "epoch_labels") + 
  scale_y_reverse()

```

- Remove EOG using regession: ```dor02_eog <- ar_eogreg(dor02_epo, heog = c("HEOGli", "HEOGre"), veog = c("VEOGo", "VEOGu"), bipolarize = TRUE)```    
- Detect high correlation with EOG channels: ```dor02_eog2 <- ar_eogcor(decomp = dor02_ICA, data = dor02_epo, HEOG = c("HEOGli", "HEOGre"), VEOG = c("VEOGo", "VEOGu"))``` -> Was sagt der plot?    
- check electrode locations: ```print(dor02_chl$chan_info, n=32)```



To-do:
- Artefacts   
- Eye Movement    
- Grand Average
- baseline nur beim plotten? -> wenn mit ggplot geht es evtl nicht anders, als dass schon vorher mit baseline berechnet wird    
- cluster based permutation test

#######

